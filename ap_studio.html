<!DOCTYPE html>
<html lang="sk" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AP Studio - Analytic Programming Studio</title>
    <style>
        /* ============================================================
           DARK FOREST THEME - Variables
           ============================================================ */
        :root[data-theme="dark"] {
            --bg-primary: #0a0f0d;
            --bg-secondary: #121816;
            --bg-tertiary: #1a2320;
            --bg-elevated: #22322c;
            
            --text-primary: #e8f2ed;
            --text-secondary: #a8c5b8;
            --text-muted: #6b8378;
            
            --accent-primary: #4ade80;
            --accent-secondary: #34d399;
            --accent-glow: rgba(74, 222, 128, 0.3);
            
            --border-subtle: rgba(74, 222, 128, 0.1);
            --border-medium: rgba(74, 222, 128, 0.2);
            
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 20px var(--accent-glow);
        }
        
        :root[data-theme="light"] {
            --bg-primary: #f8fdf9;
            --bg-secondary: #f0f7f3;
            --bg-tertiary: #e6f0ea;
            --bg-elevated: #ffffff;
            
            --text-primary: #0a0f0d;
            --text-secondary: #1a2320;
            --text-muted: #6b8378;
            
            --accent-primary: #22c55e;
            --accent-secondary: #16a34a;
            --accent-glow: rgba(34, 197, 94, 0.2);
            
            --border-subtle: rgba(34, 197, 94, 0.15);
            --border-medium: rgba(34, 197, 94, 0.25);
            
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.2);
            --shadow-glow: 0 0 20px var(--accent-glow);
        }

        /* ============================================================
           RESET & BASE
           ============================================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 
                         'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 
                         'Droid Sans', 'Helvetica Neue', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }

        .hidden {
            display: none !important;
        }

        /* ============================================================
           ANIMATED BACKGROUND
           ============================================================ */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 0;
            opacity: 0.08;
            pointer-events: none;
            background-image: 
                radial-gradient(circle at 20% 50%, var(--accent-primary) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, var(--accent-secondary) 0%, transparent 50%);
            animation: bgPulse 10s ease-in-out infinite;
        }

        @keyframes bgPulse {
            0%, 100% { opacity: 0.08; }
            50% { opacity: 0.15; }
        }

        /* ============================================================
           LAYOUT
           ============================================================ */
        .container {
            position: relative;
            z-index: 1;
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        .empty-state {
            margin-top: 80px;
            padding: 60px 40px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 18px;
            text-align: center;
            box-shadow: var(--shadow-md);
        }

        .empty-state h2 {
            font-size: 2rem;
            margin-bottom: 15px;
        }

        .empty-state p {
            color: var(--text-secondary);
            max-width: 520px;
            margin: 0 auto 25px auto;
        }

        .empty-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
        }

        /* ============================================================
           HEADER
           ============================================================ */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 17px 27px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo nav {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 20px;
        }
        
        .project-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            row-gap: 8px;
        }
        
        .project-dropdown {
            padding: 7px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-medium);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            outline: none;
            transition: all 0.3s ease;
            min-width: 200px;
        }
        
        .project-dropdown:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        
        .new-project-btn {
            padding: 7px 14px;
            background: var(--accent-primary);
            border: none;
            border-radius: 10px;
            color: var(--bg-primary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .new-project-btn:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .header-file-tabs {
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 4px 6px;
            background: var(--bg-tertiary);
            overflow-x: auto;
            flex: 1 1 320px;
            max-width: 100%;
        }

        .header-file-tabs.hidden {
            display: none;
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: logoGlow 3s ease-in-out infinite;
        }

        @keyframes logoGlow {
            0%, 100% { filter: drop-shadow(0 0 8px var(--accent-glow)); }
            50% { filter: drop-shadow(0 0 16px var(--accent-glow)); }
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-medium);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--accent-primary);
            transform: scale(1.1) rotate(15deg);
            box-shadow: var(--shadow-glow);
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-medium);
            border-radius: 12px;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-primary);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        /* ============================================================
           TABS
           ============================================================ */
        .tabs {
            display: flex;
            gap: 8px;
            padding: 4px;
            background: transparent;
        }

        .tab {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 150px;
            padding: 6px 14px;
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab:hover {
            color: var(--text-primary);
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-sm);
        }

        .tab.active {
            color: var(--text-primary);
            background: var(--accent-primary);
            border-color: transparent;
            box-shadow: var(--shadow-glow);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255, 255, 255, 0.1) 50%,
                transparent 70%
            );
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* ============================================================
           CONTENT PANELS
           ============================================================ */
        .content {
            display: none;
        }

        .content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============================================================
           BRAINSTORM VIEW (Split Pane)
           ============================================================ */
        .brainstorm-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            height: calc(100vh - 250px);
        }

        .chat-panel,
        .document-panel {
            background: transparent;
            border: none;
            border-radius: 16px;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        .document-content {
            flex: 1;
            overflow-y: auto;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 17px;
            margin-bottom: 20px;
            background: #000000;
            border: 1px solid var(--border-medium);
            border-radius: 12px;
        }

        .message {
            margin-bottom: 17px;
            padding: 12px;
            border-radius: 12px;
            animation: slideIn 0.3s ease;
            position: relative;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .message.assistant {
            background: var(--bg-tertiary);
            border-left: 3px solid var(--accent-primary);
            margin-right: 20%;
        }

        .message.user {
            background: var(--accent-primary);
            color: var(--bg-primary);
            margin-left: 20%;
        }

        .message-role {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .message-content {
            line-height: 1.6;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-medium);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .send-button {
            padding: 12px 22px;
            background: var(--accent-primary);
            color: var(--bg-primary);
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-button:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* PRD Preview */
        .prd-preview {
            flex: 1;
            overflow-y: auto;
            padding: 17px;
            background: #000000;
            border: 1px solid var(--accent-primary);
            border-radius: 12px;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 0.95rem;
            line-height: 1.8;
        }

        .prd-preview h1 {
            color: var(--accent-primary);
            margin-bottom: 15px;
        }

        .prd-preview h2 {
            color: var(--accent-secondary);
            margin-top: 25px;
            margin-bottom: 12px;
        }

        .prd-preview ul, .prd-preview ol {
            margin-left: 25px;
            margin-bottom: 12px;
        }
        
        /* PRD Line Highlighting */
        .prd-line {
            position: relative;
            padding: 2px 8px;
            margin: -2px -8px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .prd-line.modified {
            background: rgba(74, 222, 128, 0.15);
            border-left: 3px solid var(--accent-primary);
            animation: highlightPulse 2s ease-in-out;
        }
        
        .prd-line.modified:hover {
            background: rgba(74, 222, 128, 0.25);
        }
        
        .prd-line.modified .undo-btn {
            opacity: 0;
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            padding: 2px 8px;
            background: var(--accent-primary);
            color: var(--bg-primary);
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }
        
        .prd-line.modified:hover .undo-btn {
            opacity: 1;
        }
        
        @keyframes highlightPulse {
            0% { background: rgba(74, 222, 128, 0.3); }
            100% { background: rgba(74, 222, 128, 0.15); }
        }
        
        .file-tab {
            padding: 6px 12px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .file-tab:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
            border-radius: 6px 6px 0 0;
        }
        
        .file-tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }
        
        .file-tab .close-tab {
            margin-left: 6px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-tab:hover .close-tab {
            opacity: 1;
        }
        
        .file-content {
            flex: 1;
            overflow-y: auto;
            margin-top: 12px;
        }
        
        .file-view {
            display: none;
            height: 100%;
            padding: 17px;
            background: #000000;
            border: 1px solid var(--accent-primary);
            border-radius: 12px;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 0.95rem;
            line-height: 1.8;
        }
        
        .file-view.active {
            display: block;
        }

        .file-empty-state {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.95rem;
        }
        
        /* Clickable MD Sections */
        .md-clickable {
            cursor: pointer;
            padding: 3px 6px;
            margin: -3px -6px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .md-clickable:hover {
            background: rgba(74, 222, 128, 0.1);
            transform: translateX(3px);
        }
        
        .md-clickable::before {
            content: "▸ ";
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .md-clickable:hover::before {
            opacity: 0.5;
        }
        
        /* Loaded file indicator */
        .file-loaded-icon {
            color: var(--accent-primary);
            font-size: 0.8em;
            margin-right: 4px;
        }

        .action-bar {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-button {
            flex: 1;
            padding: 9px 17px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-medium);
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-button:hover {
            background: var(--accent-primary);
            color: var(--bg-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .action-button.primary {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }

        /* ============================================================
           SCROLLBAR CUSTOM STYLING
           ============================================================ */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }

        /* ============================================================
           RESPONSIVE
           ============================================================ */
        @media (max-width: 1200px) {
            .brainstorm-container {
                grid-template-columns: 1fr;
                height: auto;
            }

        .chat-panel {
            margin-top: 15px;
        }
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 15px;
            }

            .tabs {
                flex-direction: column;
            }

            .message.assistant {
                margin-right: 0;
            }

            .message.user {
                margin-left: 0;
            }
        }

        /* ============================================================
           LOADING ANIMATION
           ============================================================ */
        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-primary);
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* OpenAI-style text animation for typing effect */
        @keyframes typewriter {
            from { width: 0; }
            to { width: 100%; }
        }

        .typing-effect {
            overflow: hidden;
            white-space: nowrap;
            animation: typewriter 2s steps(40, end);
        }

        /* ============================================================
           ORCHESTRATION STYLES
           ============================================================ */
        .orch-progress {
            max-width: 900px;
            margin: 0 auto;
        }

        .orch-header-info {
            text-align: center;
            margin-bottom: 30px;
            padding: 17px;
            background: rgba(79, 222, 128, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(79, 222, 128, 0.1);
        }

        .orch-header-info h3 {
            margin: 0 0 10px 0;
            font-size: 1.5rem;
            color: var(--accent-primary);
        }

        .phase-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .phase-item {
            background: var(--card-bg);
            padding: 17px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .phase-item:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 0 20px rgba(79, 222, 128, 0.1);
        }

        .phase-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .phase-icon {
            font-size: 1.5rem;
        }

        .phase-name {
            font-weight: 600;
            font-size: 1.1rem;
            flex: 1;
        }

        .phase-status {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .phase-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(79, 222, 128, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .phase-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transition: width 0.5s ease;
            animation: pulse-progress 2s infinite;
        }

        @keyframes pulse-progress {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .phase-message {
            font-size: 0.9rem;
            opacity: 0.7;
            font-style: italic;
        }

        .wave-info {
            font-size: 0.9rem;
            color: var(--accent-primary);
            font-weight: 600;
        }

        .activity-log {
            background: var(--card-bg);
            padding: 17px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-log h4 {
            margin: 0 0 15px 0;
            font-size: 1.1rem;
        }

        .log-entries {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .log-entry {
            display: flex;
            gap: 12px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
            font-size: 0.9rem;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .log-time {
            opacity: 0.5;
            min-width: 80px;
        }

        .log-message {
            flex: 1;
        }

        .log-info {
            border-left: 3px solid var(--accent-primary);
        }

        .log-success {
            border-left: 3px solid #4ade80;
        }

        .log-error {
            border-left: 3px solid #f87171;
        }

        /* ============================================================
           WORKERS UI
           ============================================================ */
        .workers-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .workers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .worker-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 17px;
            transition: all 0.3s ease;
        }

        .worker-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-glow);
            border-color: var(--accent-primary);
        }

        .worker-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .worker-id {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .worker-type-badge {
            padding: 4px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .worker-status-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-indicator.online { background: #4ade80; }
        .status-indicator.offline { background: #6b8378; }
        .status-indicator.busy { background: #fbbf24; }
        .status-indicator.error { background: #ef4444; }

        .worker-capabilities {
            margin: 15px 0;
        }

        .capability-tag {
            display: inline-block;
            padding: 4px 10px;
            margin: 4px 4px 4px 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .worker-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-subtle);
        }

        .worker-action-btn {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .worker-action-btn:hover {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }

        /* ============================================================
           MODAL
           ============================================================ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--bg-elevated);
            border: 1px solid var(--border-medium);
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 17px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--accent-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 17px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            padding: 17px;
            border-top: 1px solid var(--border-subtle);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        /* ============================================================
           ORCHESTRATION UI
           ============================================================ */
        .orch-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .orch-controls {
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="animated-bg"></div>
    
    <div class="container">
        <!-- HEADER -->
        <header>
            <div class="logo">
                <h1>🌲 AP Studio</h1>
                <nav class="tabs">
                    <button class="tab active" onclick="switchTab('brainstorm')">
                        💬 Brainstorming
                    </button>
                    <button class="tab" onclick="switchTab('workers')">
                        👷 Workers
                    </button>
                    <button class="tab" onclick="switchTab('orchestration')">
                        🎭 Orchestration
                    </button>
                </nav>
            </div>
            <div class="header-actions">
                <div class="project-selector">
                    <select class="project-dropdown" id="projectDropdown" onchange="switchProject()">
                        <option value="">Select project...</option>
                    </select>
                    <button class="new-project-btn" onclick="createNewProject()">
                        ➕ New project
                    </button>
                </div>
                <div class="status-badge">
                    <div class="status-dot"></div>
                    <span id="statusText">Pripojené</span>
                </div>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                    <span id="themeIcon">🌙</span>
                </button>
            </div>
        </header>

        <div id="emptyState" class="empty-state">
            <h2>Welcome to AP Studio</h2>
            <p>Začni vytvorením nového projektu. AP Studio pripraví adresár v <code>~/.ap/projects/</code>, všetky kľúčové súbory a je pripravené brainstormovať.</p>
            <div class="empty-actions">
                <button class="new-project-btn" onclick="createNewProject()">
                    ➕ New project
                </button>
            </div>
        </div>

        <div id="appBody" class="hidden">
            <div class="header-file-tabs hidden" id="headerFileTabs"></div>

            <!-- BRAINSTORM CONTENT -->
            <div id="brainstorm" class="content active">
                <div class="brainstorm-container">
                    <div class="chat-panel">
                        <div class="chat-messages" id="chatMessages">
                            <!-- Messages will be added here -->
                        </div>
                        
                        <div class="chat-input-container">
                            <input 
                                type="text" 
                                class="chat-input" 
                                id="chatInput"
                                placeholder="Napíš správu..." 
                                onkeypress="handleKeyPress(event)"
                            />
                            <button class="send-button" onclick="sendMessage()">
                                Poslať 📤
                            </button>
                        </div>
                    </div>

                    <div class="document-panel">
                        <div class="document-content" id="fileContent">
                            <div class="file-empty-state" id="fileEmptyState">
                                Vyber projekt a dokumentácia sa zobrazí tu.
                            </div>
                            <div class="file-view" id="file-PRD.md">
                                <div class="prd-preview" id="prdPreview">
                                    <p style="opacity: 0.5;">PRD.md sa vytvorí počas brainstormingu...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="action-bar">
                            <button class="action-button" onclick="saveCurrentFile()">
                                💾 Save Active Tab
                            </button>
                            <button class="action-button" id="savePrdButton" onclick="savePRD()" style="display: none;">
                                💾 Save PRD
                            </button>
                            <button class="action-button primary" onclick="startOrchestration()">
                                🚀 Spustiť Orchestráciu
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WORKERS CONTENT -->
            <div id="workers" class="content">
                <div class="workers-header">
                    <h2>👷 Workers Management</h2>
                    <button class="action-button primary" onclick="showAddWorkerModal()">
                        ➕ Add Worker
                    </button>
                </div>

                <div class="workers-grid" id="workersGrid">
                    <!-- Worker cards will be added here -->
                </div>

                <!-- Add Worker Modal -->
                <div id="addWorkerModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>➕ Add New Worker</h3>
                            <button class="modal-close" onclick="closeAddWorkerModal()">✕</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Worker ID</label>
                                <input type="text" id="newWorkerID" placeholder="claude-main" class="form-input" />
                            </div>
                            <div class="form-group">
                                <label>Agent Type</label>
                                <select id="newWorkerType" class="form-input">
                                    <option value="claude">Claude</option>
                                    <option value="gpt4">GPT-4</option>
                                    <option value="codex">Codex</option>
                                    <option value="deepseek">DeepSeek</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Command</label>
                                <input type="text" id="newWorkerCommand" placeholder="python" class="form-input" />
                            </div>
                            <div class="form-group">
                                <label>Args (comma separated)</label>
                                <input type="text" id="newWorkerArgs" placeholder="workers/claude_worker.py" class="form-input" />
                            </div>
                            <div class="form-group">
                                <label>Max Concurrent Tasks</label>
                                <input type="number" id="newWorkerConcurrent" value="1" class="form-input" />
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="action-button" onclick="closeAddWorkerModal()">Cancel</button>
                            <button class="action-button primary" onclick="addWorker()">Add Worker</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ORCHESTRATION CONTENT -->
            <div id="orchestration" class="content">
                <div class="orch-header">
                    <h2>🎭 Orchestration Monitor</h2>
                    <div class="orch-controls">
                        <button class="action-button" onclick="loadOrchestrations()">
                            🔄 Refresh
                        </button>
                    </div>
                </div>

                <div id="orchestrationContent">
                    <p style="opacity: 0.6; text-align: center; padding: 40px;">
                        No active orchestrations. Start one from Brainstorming tab.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // STATE
        // ============================================================
        let ws = null;
        let currentSessionId = null;
        let currentVersionId = null;
        let currentPRD = '';

        // ============================================================
        // THEME
        // ============================================================
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            
            document.getElementById('themeIcon').textContent = newTheme === 'dark' ? '🌙' : '☀️';
            localStorage.setItem('theme', newTheme);
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.getElementById('themeIcon').textContent = savedTheme === 'dark' ? '🌙' : '☀️';

        // ============================================================
        // TABS
        // ============================================================
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
        }

        // ============================================================
        // WEBSOCKET
        // ============================================================
        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:8000/ws/brainstorm');

            ws.onopen = () => {
                console.log('✓ WebSocket connected');
                document.getElementById('statusText').textContent = 'Pripojené';
                
                // Start brainstorm session
                startBrainstormSession();
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            ws.onclose = () => {
                console.log('✗ WebSocket disconnected');
                document.getElementById('statusText').textContent = 'Odpojené';
                
                // Reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        function handleWebSocketMessage(data) {
            console.log('Message received:', data);

            switch (data.type) {
                case 'session_started':
                    currentSessionId = data.session_id;
                    currentVersionId = data.version_id;
                    addMessage('assistant', data.message);
                    break;

                case 'response':
                    addMessage('assistant', data.message);
                    if (data.prd_content) {
                        updatePRD(data.prd_content, data.prd_changes || []);
                    }
                    break;
                
                case 'prd_change':
                    // Agent is modifying PRD in real-time
                    const lines = currentPRD.split('\n');
                    const oldValue = lines[data.line_number];
                    lines[data.line_number] = data.new_value;
                    currentPRD = lines.join('\n');
                    
                    // Add to changes and re-render with highlight
                    const changes = [{
                        line_number: data.line_number,
                        old_value: oldValue,
                        new_value: data.new_value
                    }];
                    updatePRD(currentPRD, changes);
                    break;

                case 'prd_saved':
                    alert('✓ PRD saved successfully!');
                    break;
            }
        }

        function startBrainstormSession() {
            // Auto-start with current project if exists
            if (currentProjectId && projects[currentProjectId]) {
                ws.send(JSON.stringify({
                    type: 'start',
                    project_id: currentProjectId,
                    project_name: projects[currentProjectId].name
                }));
            } else {
                // First project - start brainstorming to define project
                ws.send(JSON.stringify({
                    type: 'start',
                    project_name: 'Nový projekt (brainstorming...)'
                }));
            }
        }

        // ============================================================
        // CHAT
        // ============================================================
        function addMessage(role, content) {
            const messagesDiv = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = `
                <div class="message-role">${role === 'user' ? '👤 You' : '🤖 AI'}</div>
                <div class="message-content">${content}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || !currentSessionId) return;

            // Add user message
            addMessage('user', message);

            // Send to server
            ws.send(JSON.stringify({
                type: 'message',
                session_id: currentSessionId,
                content: message
            }));

            // Clear input
            input.value = '';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // ============================================================
        // PRD
        // ============================================================
        let prdHistory = {}; // Track original values for undo
        let prdLineMap = {}; // Map line numbers to content
        
        function updatePRD(content, changes = []) {
            currentPRD = content;
            ensureFileView('PRD.md');
            
            // Parse content into lines
            const lines = content.split('\n');
            prdLineMap = {};
            lines.forEach((line, idx) => {
                prdLineMap[idx] = line;
            });
            
            // Render markdown with highlighting
            const preview = document.getElementById('prdPreview');
            if (!preview) return;
            preview.innerHTML = renderPRDWithHighlights(content, changes);
        }
        
        function renderPRDWithHighlights(text, changes = []) {
            const lines = text.split('\n');
            const modifiedLines = new Set(changes.map(c => c.line_number));
            
            let html = '';
            lines.forEach((line, idx) => {
                const isModified = modifiedLines.has(idx);
                const change = changes.find(c => c.line_number === idx);
                
                if (isModified && change) {
                    // Store original value for undo
                    if (!prdHistory[idx]) {
                        prdHistory[idx] = change.old_value;
                    }
                    
                    html += `<div class="prd-line modified" data-line="${idx}">`;
                    html += marked(line);
                    html += `<button class="undo-btn" onclick="undoPRDChange(${idx})">↶ Undo</button>`;
                    html += '</div>';
                } else {
                    html += `<div class="prd-line" data-line="${idx}">`;
                    html += marked(line);
                    html += '</div>';
                }
            });
            
            return html;
        }
        
        function undoPRDChange(lineNumber) {
            if (prdHistory[lineNumber]) {
                // Restore original value
                const lines = currentPRD.split('\n');
                lines[lineNumber] = prdHistory[lineNumber];
                currentPRD = lines.join('\n');
                
                // Remove from history
                delete prdHistory[lineNumber];
                
                // Re-render without this change
                const remainingChanges = Object.keys(prdHistory).map(ln => ({
                    line_number: parseInt(ln),
                    old_value: prdHistory[ln]
                }));
                
                updatePRD(currentPRD, remainingChanges);
                
                // Notify agent of undo
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'undo_change',
                        session_id: currentSessionId,
                        line_number: lineNumber
                    }));
                }
            }
        }

        // Simple markdown renderer
        function marked(text) {
            return text
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^\- (.*$)/gim, '<li>$1</li>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\*\*(.*)\*\*/g, '<strong>$1</strong>');
        }

        function savePRD() {
            if (!currentSessionId) return;

            ws.send(JSON.stringify({
                type: 'save_prd',
                session_id: currentSessionId,
                prd_content: currentPRD
            }));
        }

        let orchestrationWS = null;
        let currentOrchestrationId = null;

        function startOrchestration() {
            if (!currentVersionId) {
                alert('⚠️ Najprv dokončite brainstorming!');
                return;
            }

            if (confirm('🚀 Spustiť orchestráciu?\n\nToto spustí multi-agent orchestration pre implementáciu PRD.md')) {
                // Switch to orchestration tab
                switchTab('orchestration');
                
                // Connect orchestration WebSocket
                connectOrchestrationWebSocket();
                
                // Send start message
                setTimeout(() => {
                    if (orchestrationWS && orchestrationWS.readyState === WebSocket.OPEN) {
                        orchestrationWS.send(JSON.stringify({
                            type: 'start',
                            version_id: currentVersionId
                        }));
                    }
                }, 500);
            }
        }

        function connectOrchestrationWebSocket() {
            if (orchestrationWS) {
                orchestrationWS.close();
            }

            orchestrationWS = new WebSocket('ws://localhost:8000/ws/orchestration');

            orchestrationWS.onopen = () => {
                console.log('✓ Orchestration WebSocket connected');
            };

            orchestrationWS.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleOrchestrationUpdate(data);
            };

            orchestrationWS.onclose = () => {
                console.log('✗ Orchestration WebSocket disconnected');
            };

            orchestrationWS.onerror = (error) => {
                console.error('Orchestration WebSocket error:', error);
            };
        }

        function handleOrchestrationUpdate(data) {
            console.log('Orchestration update:', data);

            const content = document.getElementById('orchestrationContent');

            switch (data.type) {
                case 'orchestration_started':
                    currentOrchestrationId = data.orchestration_id;
                    content.innerHTML = `
                        <div class="orch-progress" id="orchProgress">
                            <div class="orch-header-info">
                                <h3>🎭 Orchestration #${data.orchestration_id}</h3>
                                <p>Version: ${data.version}</p>
                            </div>
                            
                            <div class="phase-container" id="phaseContainer">
                                <div class="phase-item" id="phase-analytic">
                                    <div class="phase-header">
                                        <span class="phase-icon">🔍</span>
                                        <span class="phase-name">ANALYTIC</span>
                                        <span class="phase-status">⏸️ Pending</span>
                                    </div>
                                    <div class="phase-progress-bar">
                                        <div class="phase-progress-fill" style="width: 0%"></div>
                                    </div>
                                    <div class="phase-message"></div>
                                </div>

                                <div class="phase-item" id="phase-planning">
                                    <div class="phase-header">
                                        <span class="phase-icon">📋</span>
                                        <span class="phase-name">PLANNING</span>
                                        <span class="phase-status">⏸️ Pending</span>
                                    </div>
                                    <div class="phase-progress-bar">
                                        <div class="phase-progress-fill" style="width: 0%"></div>
                                    </div>
                                    <div class="phase-message"></div>
                                </div>

                                <div class="phase-item" id="phase-execution">
                                    <div class="phase-header">
                                        <span class="phase-icon">⚡</span>
                                        <span class="phase-name">EXECUTION</span>
                                        <span class="phase-status">⏸️ Pending</span>
                                    </div>
                                    <div class="phase-progress-bar">
                                        <div class="phase-progress-fill" style="width: 0%"></div>
                                    </div>
                                    <div class="phase-message"></div>
                                    <div class="wave-info" style="margin-top: 10px; opacity: 0.7;"></div>
                                </div>
                            </div>

                            <div class="activity-log" id="activityLog">
                                <h4>📊 Activity Log</h4>
                                <div class="log-entries"></div>
                            </div>
                        </div>
                    `;
                    addLogEntry('Orchestration started', 'info');
                    break;

                case 'phase_update':
                    updatePhaseProgress(data);
                    addLogEntry(`${data.phase.toUpperCase()}: ${data.message}`, 'info');
                    break;

                case 'orchestration_complete':
                    markPhaseComplete('execution');
                    addLogEntry('✅ Orchestration complete!', 'success');
                    setTimeout(() => {
                        alert('✅ Orchestration completed successfully!\n\nCheck the results in the orchestration log.');
                    }, 500);
                    break;

                case 'orchestration_error':
                    addLogEntry(`✗ Error: ${data.error}`, 'error');
                    alert(`✗ Orchestration failed: ${data.error}`);
                    break;
            }
        }

        function updatePhaseProgress(data) {
            const phaseId = `phase-${data.phase}`;
            const phaseEl = document.getElementById(phaseId);
            
            if (!phaseEl) return;

            // Update status
            const statusEl = phaseEl.querySelector('.phase-status');
            statusEl.textContent = '🔄 Running';
            statusEl.style.color = 'var(--accent-primary)';

            // Update progress bar
            const progressBar = phaseEl.querySelector('.phase-progress-fill');
            progressBar.style.width = `${data.progress}%`;

            // Update message
            const messageEl = phaseEl.querySelector('.phase-message');
            messageEl.textContent = data.message;

            // Update wave info for execution phase
            if (data.phase === 'execution' && data.wave) {
                const waveInfo = phaseEl.querySelector('.wave-info');
                waveInfo.textContent = `Wave ${data.wave}/${data.total_waves}`;
            }

            // Mark previous phases complete
            if (data.phase === 'planning') {
                markPhaseComplete('analytic');
            } else if (data.phase === 'execution') {
                markPhaseComplete('analytic');
                markPhaseComplete('planning');
            }
        }

        function markPhaseComplete(phase) {
            const phaseEl = document.getElementById(`phase-${phase}`);
            if (!phaseEl) return;

            const statusEl = phaseEl.querySelector('.phase-status');
            statusEl.textContent = '✅ Complete';
            statusEl.style.color = '#4ade80';

            const progressBar = phaseEl.querySelector('.phase-progress-fill');
            progressBar.style.width = '100%';
        }

        function addLogEntry(message, type = 'info') {
            const logEntries = document.querySelector('.log-entries');
            if (!logEntries) return;

            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `
                <span class="log-time">${new Date().toLocaleTimeString('sk-SK')}</span>
                <span class="log-message">${message}</span>
            `;
            
            logEntries.insertBefore(entry, logEntries.firstChild);
            
            // Limit to 50 entries
            while (logEntries.children.length > 50) {
                logEntries.removeChild(logEntries.lastChild);
            }
        }

        // ============================================================
        // WORKERS MANAGEMENT
        // ============================================================
        let workersWS = null;
        let workers = {};

        async function loadWorkers() {
            try {
                const response = await fetch('http://localhost:8000/api/workers');
                const data = await response.json();
                
                // Clear grid
                const grid = document.getElementById('workersGrid');
                grid.innerHTML = '';
                
                // Render workers
                if (data.workers && data.workers.length > 0) {
                    data.workers.forEach(worker => {
                        workers[worker.worker_id] = worker;
                        renderWorkerCard(worker);
                    });
                } else {
                    grid.innerHTML = '<p style="opacity: 0.6; text-align: center; padding: 40px; grid-column: 1/-1;">No workers configured. Click "Add Worker" to get started.</p>';
                }
            } catch (error) {
                console.error('Failed to load workers:', error);
            }
        }

        function renderWorkerCard(worker) {
            const grid = document.getElementById('workersGrid');
            
            const card = document.createElement('div');
            card.className = 'worker-card';
            card.id = `worker-card-${worker.worker_id}`;
            
            const statusClass = worker.status || 'offline';
            const capabilities = worker.capabilities || [];
            
            card.innerHTML = `
                <div class="worker-card-header">
                    <div class="worker-id">${worker.worker_id}</div>
                    <div class="worker-type-badge">${worker.agent_type}</div>
                </div>
                
                <div class="worker-status-row">
                    <div class="status-indicator ${statusClass}"></div>
                    <span style="text-transform: capitalize;">${statusClass}</span>
                    <span style="margin-left: auto; opacity: 0.7;">Max: ${worker.max_concurrent || 1}</span>
                </div>
                
                <div class="worker-capabilities">
                    <div style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 8px;">Capabilities:</div>
                    ${capabilities.length > 0 
                        ? capabilities.map(cap => `<span class="capability-tag">${cap}</span>`).join('')
                        : '<span style="opacity: 0.5;">None configured</span>'
                    }
                </div>
                
                <div class="worker-actions">
                    <button class="worker-action-btn" onclick="discoverWorkerCapabilities('${worker.worker_id}')">
                        🔍 Discover
                    </button>
                    <button class="worker-action-btn" onclick="toggleWorker('${worker.worker_id}', ${worker.enabled})">
                        ${worker.enabled ? '⏸️ Disable' : '▶️ Enable'}
                    </button>
                    <button class="worker-action-btn" onclick="removeWorker('${worker.worker_id}')">
                        🗑️ Remove
                    </button>
                </div>
            `;
            
            grid.appendChild(card);
        }

        function showAddWorkerModal() {
            document.getElementById('addWorkerModal').classList.add('active');
        }

        function closeAddWorkerModal() {
            document.getElementById('addWorkerModal').classList.remove('active');
            
            // Clear form
            document.getElementById('newWorkerID').value = '';
            document.getElementById('newWorkerType').value = 'claude';
            document.getElementById('newWorkerCommand').value = '';
            document.getElementById('newWorkerArgs').value = '';
            document.getElementById('newWorkerConcurrent').value = '1';
        }

        async function addWorker() {
            const workerId = document.getElementById('newWorkerID').value.trim();
            const workerType = document.getElementById('newWorkerType').value;
            const command = document.getElementById('newWorkerCommand').value.trim();
            const args = document.getElementById('newWorkerArgs').value.trim();
            const maxConcurrent = parseInt(document.getElementById('newWorkerConcurrent').value);
            
            if (!workerId || !command) {
                alert('⚠️ Worker ID and Command are required!');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:8000/api/workers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        worker_id: workerId,
                        agent_type: workerType,
                        capabilities: [],  // Will be discovered
                        mcp_config: {
                            command: command,
                            args: args.split(',').map(a => a.trim()).filter(a => a),
                            env: {}
                        },
                        max_concurrent: maxConcurrent
                    })
                });
                
                if (response.ok) {
                    closeAddWorkerModal();
                    loadWorkers();
                    alert('✓ Worker added successfully!');
                } else {
                    const error = await response.json();
                    alert(`✗ Failed to add worker: ${error.detail}`);
                }
            } catch (error) {
                alert(`✗ Error: ${error.message}`);
            }
        }

        async function discoverWorkerCapabilities(workerId) {
            if (!confirm(`🔍 Discover capabilities for ${workerId}?\n\nThis will:\n1. Start the worker\n2. Query available tools\n3. Analyze with LLM\n4. Update capabilities`)) {
                return;
            }
            
            try {
                // TODO: Implement discovery via API
                // - Add POST /api/workers/{worker_id}/discover endpoint
                // - Stream discovery progress via WebSocket
                // - Show progress modal with LLM analysis steps
                // - Update worker card capabilities in real-time
                // - Handle errors gracefully (worker start failure, LLM errors)
                alert(`Capability discovery for ${workerId} will be implemented with orchestrator integration.`);
            } catch (error) {
                alert(`✗ Discovery failed: ${error.message}`);
            }
        }

        async function toggleWorker(workerId, currentlyEnabled) {
            // TODO: Implement enable/disable
            // - Add PATCH /api/workers/{worker_id} endpoint (update enabled field)
            // - Update database worker record
            // - Broadcast via WebSocket to all clients
            // - Update UI: status indicator, action button text
            // - If disabling: warn if worker has active tasks
            alert(`Toggle ${workerId} - feature coming soon`);
        }

        async function removeWorker(workerId) {
            if (!confirm(`🗑️ Remove worker ${workerId}?\n\nThis cannot be undone.`)) {
                return;
            }
            
            try {
                // TODO: Implement remove via API
                // - Add DELETE /api/workers/{worker_id} endpoint
                // - Prevent deletion if worker has active orchestrations
                // - Remove from database (workers table)
                // - Optional: remove from team.json (with backup)
                // - Broadcast removal via WebSocket
                // - Fade out and remove worker card from UI
                alert(`Remove worker feature coming soon`);
            } catch (error) {
                alert(`✗ Failed to remove: ${error.message}`);
            }
        }

        function connectWorkersWebSocket() {
            workersWS = new WebSocket('ws://localhost:8000/ws/workers');
            
            workersWS.onopen = () => {
                console.log('✓ Workers WebSocket connected');
            };
            
            workersWS.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === 'worker_list') {
                    // Initial worker list
                    data.workers.forEach(worker => {
                        workers[worker.worker_id] = worker;
                    });
                } else if (data.type === 'worker_added') {
                    // New worker added
                    loadWorkers();
                } else if (data.type === 'worker_status') {
                    // Worker status update
                    updateWorkerStatus(data.worker_id, data.status);
                }
            };
            
            workersWS.onclose = () => {
                console.log('✗ Workers WebSocket disconnected');
                setTimeout(connectWorkersWebSocket, 3000);
            };
        }

        function updateWorkerStatus(workerId, status) {
            const card = document.getElementById(`worker-card-${workerId}`);
            if (card) {
                const indicator = card.querySelector('.status-indicator');
                const statusText = card.querySelector('.worker-status-row span');
                
                indicator.className = `status-indicator ${status}`;
                statusText.textContent = status;
            }
        }

        // ============================================================
        // ORCHESTRATION MONITOR
        // ============================================================
        async function loadOrchestrations() {
            // TODO: Enhance orchestration history display
            // - Add filter controls (All / Active / Completed / Failed)
            // - Add date range picker for historical orchestrations
            // - Add search by version/project name
            // - Add pagination (load more button)
            // - Add sorting options (newest first, by status, by duration)
            // - Add "Cancel" button for running orchestrations
            // - Add "View Details" button to show full logs
            // - Add "Retry" button for failed orchestrations
            
            try {
                const response = await fetch('http://localhost:8000/api/orchestrations/active');
                const data = await response.json();
                
                const content = document.getElementById('orchestrationContent');
                
                if (data.orchestrations && data.orchestrations.length > 0) {
                    // Render orchestrations
                    content.innerHTML = data.orchestrations.map(orch => `
                        <div style="background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3>Orchestration #${orch.id}</h3>
                                    <p style="opacity: 0.7;">Status: ${orch.status} | Phase: ${orch.phase || 'Starting'}</p>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.5rem;">${orch.current_wave || 0}/${orch.total_waves || '?'}</div>
                                    <div style="font-size: 0.85rem; opacity: 0.7;">Waves</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    content.innerHTML = '<p style="opacity: 0.6; text-align: center; padding: 40px;">No active orchestrations. Start one from Brainstorming tab.</p>';
                }
            } catch (error) {
                console.error('Failed to load orchestrations:', error);
            }
        }

        // ============================================================
        // PROJECT MANAGEMENT
        // ============================================================
        let currentProjectId = null;
        let projects = {};
        let projectFiles = {};  // Loaded project files
        let loadedFiles = new Set();  // Files loaded as context
        let openTabs = new Set();  // Open file tabs
        let currentFile = null;  // Currently active file
        
        function updateProjectUI() {
            const hasProject = Boolean(currentProjectId);
            const appBody = document.getElementById('appBody');
            const emptyState = document.getElementById('emptyState');
            const headerTabs = document.getElementById('headerFileTabs');
            if (appBody) {
                appBody.classList.toggle('hidden', !hasProject);
            }
            if (emptyState) {
                emptyState.classList.toggle('hidden', hasProject);
            }
            if (headerTabs) {
                if (!hasProject || headerTabs.childElementCount === 0) {
                    headerTabs.classList.add('hidden');
                } else {
                    headerTabs.classList.remove('hidden');
                }
            }
        }
        
        async function activateProject(projectId) {
            const id = projectId ? String(projectId) : null;
            if (!id || !projects[id]) {
                currentProjectId = null;
                updateProjectUI();
                return;
            }
            
            const dropdown = document.getElementById('projectDropdown');
            if (dropdown) {
                dropdown.value = id;
            }
            
            currentProjectId = id;
            const project = projects[id];
            console.log(`Switched to project: ${project.name}`);
            
            try {
                await loadProjectFiles(project.name);
                updateDocumentTitle(currentFile);
            } finally {
                updateProjectUI();
            }
        }
        
        function getFileViewId(filename) {
            return `file-${filename.replace(/[^\w.-]/g, '_')}`;
        }

        function ensureFileView(filename) {
            const fileContent = document.getElementById('fileContent');
            if (!fileContent) return null;

            const emptyState = document.getElementById('fileEmptyState');
            if (emptyState) {
                emptyState.remove();
            }

            const viewId = getFileViewId(filename);
            let fileView = document.getElementById(viewId);
            if (!fileView) {
                fileView = document.createElement('div');
                fileView.className = 'file-view';
                fileView.id = viewId;
                fileContent.appendChild(fileView);
            }

            if (filename === 'PRD.md' && !fileView.querySelector('#prdPreview')) {
                const preview = document.createElement('div');
                preview.className = 'prd-preview';
                preview.id = 'prdPreview';
                preview.innerHTML = '<p style="opacity: 0.5;">PRD.md sa vytvorí počas brainstormingu...</p>';
                fileView.appendChild(preview);
            }

            return fileView;
        }

        function updateDocumentTitle(filename) {
            const titleEl = document.getElementById('documentTitle');
            const savePrdBtn = document.getElementById('savePrdButton');
            
            if (!titleEl) return;
            
            if (!filename || !projectFiles[filename]) {
                titleEl.textContent = '📄 Aktívny súbor';
                if (savePrdBtn) savePrdBtn.style.display = 'none';
                return;
            }
            
            const icon = projectFiles[filename].icon || '📄';
            titleEl.textContent = `${icon} ${filename}`;
            
            if (savePrdBtn) {
                savePrdBtn.style.display = filename === 'PRD.md' ? '' : 'none';
            }
        }

        function resetDocumentView(message = 'Vyber projekt a dokumentácia sa zobrazí tu.') {
            const fileContent = document.getElementById('fileContent');
            if (!fileContent) return;

            fileContent.innerHTML = `
                <div class="file-empty-state" id="fileEmptyState">
                    ${message}
                </div>
                <div class="file-view" id="file-PRD.md">
                    <div class="prd-preview" id="prdPreview">
                        <p style="opacity: 0.5;">PRD.md sa vytvorí počas brainstormingu...</p>
                    </div>
                </div>
            `;
        }

        async function loadProjects(selectProjectId = null) {
            try {
                const response = await fetch('http://localhost:8000/api/projects');
                const data = await response.json();
                
                const dropdown = document.getElementById('projectDropdown');
                dropdown.innerHTML = '<option value="">Select project...</option>';
                projects = {};
                
                if (data.projects && data.projects.length > 0) {
                    data.projects.forEach(project => {
                        const id = String(project.id);
                        projects[id] = project;
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = project.name;
                        dropdown.appendChild(option);
                    });
                    
                    let targetId = selectProjectId !== null ? String(selectProjectId) : null;
                    if (targetId && !projects[targetId]) {
                        targetId = null;
                    }
                    
                    if (!targetId && currentProjectId && projects[currentProjectId]) {
                        targetId = currentProjectId;
                    }
                    
                    if (!targetId) {
                        targetId = String(data.projects[0].id);
                    }
                    
                    await activateProject(targetId);
                } else {
                    currentProjectId = null;
                    updateDocumentTitle(null);
                    updateProjectUI();
                }
            } catch (error) {
                console.error('Failed to load projects:', error);
                currentProjectId = null;
                updateDocumentTitle(null);
                updateProjectUI();
            }
        }

        async function switchProject() {
            const dropdown = document.getElementById('projectDropdown');
            const projectId = dropdown.value;
            
            if (!projectId) {
                currentProjectId = null;
                projectFiles = {};
                openTabs.clear();
                loadedFiles.clear();
                const headerTabs = document.getElementById('headerFileTabs');
                if (headerTabs) {
                    headerTabs.innerHTML = '';
                    headerTabs.classList.add('hidden');
                }
                resetDocumentView();
                updateDocumentTitle(null);
                updateProjectUI();
                return;
            }
            
            await activateProject(projectId);
        }
        
        async function loadProjectFiles(projectName) {
            if (!projectName) return;

            try {
                const response = await fetch(`http://localhost:8000/api/projects/${projectName}/files`);
                const data = await response.json();
                
                if (data.files) {
                    projectFiles = {};
                    loadedFiles.clear();
                    openTabs.clear();
                    
                    const headerTabs = document.getElementById('headerFileTabs');

                    if (headerTabs) {
                        headerTabs.innerHTML = '';
                        headerTabs.classList.add('hidden');
                    }

                    resetDocumentView();
                    
                    data.files.forEach(file => {
                        projectFiles[file.name] = file;
                        if (file.loaded) {
                            loadedFiles.add(file.name);
                        }
                    });
                    
                    console.log(`✓ Loaded ${data.files.length} files for ${projectName}`);
                    console.log(`✓ Context files: ${Array.from(loadedFiles).join(', ')}`);
                    
                    const prdFile = projectFiles['PRD.md'];
                    if (prdFile) {
                        updatePRD(prdFile.content || '', prdFile.changes || []);
                    } else {
                        currentPRD = '';
                        prdHistory = {};
                        prdLineMap = {};
                        const preview = document.getElementById('prdPreview');
                        if (preview) {
                            preview.innerHTML = '<p style="opacity: 0.5;">PRD.md sa vytvorí počas brainstormingu...</p>';
                        }
                    }
                    
                    const priorityOrder = ['README.md', 'PRD.md', 'CURRENT_IMPLEMENTATION.md', 'AGENTS.md'];
                    const sortedFiles = data.files
                        .slice()
                        .sort((a, b) => {
                            const aPriority = priorityOrder.indexOf(a.name);
                            const bPriority = priorityOrder.indexOf(b.name);
                            const aRank = aPriority === -1 ? 99 : aPriority;
                            const bRank = bPriority === -1 ? 99 : bPriority;
                            if (aRank !== bRank) {
                                return aRank - bRank;
                            }
                            return a.name.localeCompare(b.name);
                        });
                    
                    let firstTab = null;
                    sortedFiles.forEach(file => {
                        addFileTab(file.name, { pinned: file.name === 'README.md' });
                        updateFileTabContent(file.name, file.content || '', file.changes || []);
                        
                        if (!firstTab) {
                            firstTab = file.name;
                        }
                        if (file.name === 'README.md') {
                            firstTab = file.name;
                        }
                    });
                    
                    if (firstTab) {
                        switchFileTab(firstTab);
                    } else {
                        currentFile = null;
                        updateDocumentTitle(null);
                    }
                }
            } catch (error) {
                console.error('Failed to load project files:', error);
                resetDocumentView('Nepodarilo sa načítať súbory projektu. Skús obnoviť alebo vybrať projekt znova.');
                updateDocumentTitle(null);
            }
        }
        
        function addFileTab(filename, { pinned = false } = {}) {
            if (openTabs.has(filename)) {
                const existing = document.querySelector(`.file-tab[data-file="${filename}"]`);
                if (existing && pinned) {
                    existing.dataset.pinned = 'true';
                    const closeBtn = existing.querySelector('.close-tab');
                    if (closeBtn) {
                        closeBtn.remove();
                    }
                }
                ensureFileView(filename);
                return;
            }

            const file = projectFiles[filename];
            if (!file) return;
            
            const fileTabs = document.getElementById('headerFileTabs');
            if (!fileTabs) return;

            openTabs.add(filename);
            
            const tab = document.createElement('button');
            tab.className = 'file-tab';
            tab.dataset.file = filename;
            if (pinned) {
                tab.dataset.pinned = 'true';
            }
            tab.onclick = () => switchFileTab(filename);

            if (loadedFiles.has(filename)) {
                const indicator = document.createElement('span');
                indicator.className = 'file-loaded-icon';
                indicator.textContent = '✅';
                tab.appendChild(indicator);
            }

            const label = document.createElement('span');
            const icon = file.icon || '📄';
            label.textContent = `${icon} ${filename}`;
            tab.appendChild(label);

            if (!pinned) {
                const closeBtn = document.createElement('span');
                closeBtn.className = 'close-tab';
                closeBtn.textContent = '✕';
                closeBtn.onclick = (event) => closeFileTab(event, filename);
                tab.appendChild(closeBtn);
            }
            
            fileTabs.appendChild(tab);
            fileTabs.classList.remove('hidden');
            ensureFileView(filename);
        }
        
        function switchFileTab(filename) {
            if (!filename) return;
            currentFile = filename;
            updateDocumentTitle(filename);
            
            // Update tab active state
            document.querySelectorAll('.file-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.file === filename);
            });
            
            // Update file view active state
            const viewId = getFileViewId(filename);
            ensureFileView(filename);
            document.querySelectorAll('.file-view').forEach(view => {
                view.classList.toggle('active', view.id === viewId);
            });
        }
        
        function closeFileTab(event, filename) {
            event.stopPropagation();
            
            const tab = document.querySelector(`.file-tab[data-file="${filename}"]`);
            if (tab && tab.dataset.pinned === 'true') {
                alert(`⚠️ ${filename} nemôžeš zatvoriť - je pripnutý k projektu`);
                return;
            }
            
            openTabs.delete(filename);
            
            if (tab) {
                tab.remove();
            }
            
            const view = document.getElementById(getFileViewId(filename));
            if (view) {
                view.remove();
            }
            
            if (currentFile === filename) {
                const fallbackTab = document.querySelector('.file-tab');
                if (fallbackTab) {
                    switchFileTab(fallbackTab.dataset.file);
                } else {
                    currentFile = null;
                    resetDocumentView();
                    updateDocumentTitle(null);
                }
            }
            
            const headerTabs = document.getElementById('headerFileTabs');
            if (headerTabs && headerTabs.childElementCount === 0) {
                headerTabs.classList.add('hidden');
            }
        }
        
        function loadFileContent(filename) {
            const file = projectFiles[filename];
            if (!file) return;
            
            updateFileTabContent(filename, file.content || '', file.changes || []);
            switchFileTab(filename);
        }
        
        function updateFileTabContent(filename, content, changes = []) {
            const fileView = ensureFileView(filename);
            if (!fileView) return;
            
            if (filename === 'PRD.md') {
                updatePRD(content || '', changes);
                return;
            }
            
            fileView.innerHTML = renderClickableMarkdown(content || '', filename);
        }
        
        function renderClickableMarkdown(content, filename) {
            // Make specific sections clickable based on file type
            let html = marked(content);
            
            if (filename === 'TODOs.md' || filename === 'BUGs.md') {
                // Make TODO/BUG items clickable
                html = html.replace(
                    /<li>(.*?)<\/li>/g,
                    (match, text) => {
                        const cleanText = text.replace(/<[^>]*>/g, '').trim();
                        return `<li class="md-clickable" onclick="sendToChat('${escapeHtml(cleanText)}')">${text}</li>`;
                    }
                );
            } else if (filename === 'PRD.md' || filename === 'FEATURES.md') {
                // Make features/requirements clickable
                html = html.replace(
                    /<li>(F\d+:|R\d+:.*?)<\/li>/g,
                    (match, text) => {
                        const cleanText = text.replace(/<[^>]*>/g, '').trim();
                        return `<li class="md-clickable" onclick="sendToChat('${escapeHtml(cleanText)}')">${text}</li>`;
                    }
                );
            }
            
            return html;
        }
        
        function escapeHtml(text) {
            return text
                .replace(/'/g, "\\'")
                .replace(/"/g, '\\"')
                .replace(/\n/g, ' ');
        }
        
        function sendToChat(text) {
            // Auto-fill chat input and optionally send
            const chatInput = document.getElementById('chatInput');
            chatInput.value = text;
            chatInput.focus();
            
            // Optional: auto-send
            if (confirm(`📤 Poslať do chatu?\n\n"${text}"`)) {
                sendMessage();
            }
        }
        
        function saveCurrentFile() {
            if (!currentFile) {
                alert('⚠️ Najprv vyber panel so súborom.');
                return;
            }
            // Save current file content
            alert(`💾 Saving ${currentFile}...`);
            
            // TODO: Implement save to backend
            // - POST /api/projects/{name}/files/{filename}
            // - Send updated content
            // - Auto-commit to Git
            // - Show success/error notification
        }

        function createNewProject() {
            const projectName = prompt('Názov nového projektu:', 'my-new-project');
            
            if (!projectName || !projectName.trim()) return;
            
            fetch('http://localhost:8000/api/projects', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: projectName.trim()
                })
            })
            .then(async response => {
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Neznáma chyba servera');
                }
                return response.json();
            })
            .then(async data => {
                if (data.success && data.project_id) {
                    const newId = String(data.project_id);
                    await loadProjects(newId);
                    alert(`✓ Projekt "${projectName.trim()}" bol vytvorený!`);
                } else {
                    throw new Error('Server neposlal platnú odpoveď.');
                }
            })
            .catch(error => {
                alert(`✗ Chyba pri vytváraní projektu: ${error.message}`);
            });
        }

        // ============================================================
        // INIT
        // ============================================================
        connectWebSocket();
        connectWorkersWebSocket();
        loadProjects();
        
        // Load workers when switching to Workers tab
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                if (e.target.textContent.includes('Workers')) {
                    loadWorkers();
                } else if (e.target.textContent.includes('Orchestration')) {
                    loadOrchestrations();
                }
            });
        });
    </script>
</body>
</html>
